<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>notDumb - Planificador v6.2</title>
    
    <!-- Librer√≠as externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');

        :root {
            --green: #9DFF57;
            --green-dark: #7DE83A;
            --green-glow: rgba(157, 255, 87, 0.25);
            --green-subtle: rgba(157, 255, 87, 0.08);
            --bg: #070D07;
            --surface: #0F1A0F;
            --surface-2: #162116;
            --surface-3: #1C2B1C;
            --border: rgba(157, 255, 87, 0.15);
            --border-strong: rgba(157, 255, 87, 0.35);
            --text: #F0F4F0;
            --text-muted: rgba(240, 244, 240, 0.55);
            --text-dim: rgba(240, 244, 240, 0.3);
            --danger: #FF5555;
            --danger-subtle: rgba(255, 85, 85, 0.1);
            --warning: #FFB347;
            --warning-subtle: rgba(255, 179, 71, 0.1);
            --orange: #FF9800;
            --orange-subtle: rgba(255, 152, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: var(--text);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--green); }

        .container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 0 60px rgba(0,0,0,0.6), 0 0 120px rgba(157,255,87,0.04);
            max-width: 1400px;
            width: 100%;
            padding: 40px;
            max-height: 96vh;
            overflow-y: auto;
            margin-top: 20px;
        }

        /* ‚îÄ‚îÄ LOGO ‚îÄ‚îÄ */
        .logo {
            text-align: center;
            margin-bottom: 32px;
            padding: 28px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: -60px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 120px;
            background: var(--green-glow);
            border-radius: 50%;
            filter: blur(40px);
            pointer-events: none;
        }

        .logo h1 {
            color: var(--text);
            font-size: 2.8em;
            margin-bottom: 6px;
            font-weight: 800;
            letter-spacing: -0.02em;
            position: relative;
        }

        .logo h1 .not {
            color: var(--green);
        }

        .logo p {
            color: var(--text-muted);
            font-size: 1em;
            font-weight: 300;
            letter-spacing: 0.05em;
            position: relative;
        }

        .version-badge {
            display: inline-block;
            background: var(--green-subtle);
            color: var(--green);
            border: 1px solid var(--border-strong);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 10px;
            position: relative;
            letter-spacing: 0.03em;
        }

        /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
        .screen { display: none; }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ HEADINGS ‚îÄ‚îÄ */
        h2 {
            color: var(--text) !important;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        h3 { color: var(--text); font-weight: 600; }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            background: var(--green);
            color: #070D07;
            padding: 13px 28px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.01em;
        }

        .btn:hover {
            background: var(--green-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--green-glow);
        }

        .btn:active { transform: translateY(0); }

        .btn-secondary {
            background: var(--surface-3);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-2);
            color: var(--text);
            box-shadow: none;
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid rgba(255, 85, 85, 0.4);
        }

        .btn-danger:hover {
            background: var(--danger-subtle);
            box-shadow: 0 4px 16px rgba(255, 85, 85, 0.2);
        }

        /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 28px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 12px 22px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-family: 'Poppins', sans-serif;
            margin-bottom: -1px;
        }

        .tab:hover { color: var(--text); }

        .tab.active {
            color: var(--green);
            border-bottom-color: var(--green);
        }

        .tab-content { display: none; }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.25s ease-out;
        }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            border-left: 3px solid var(--green);
            transition: border-color 0.2s;
        }

        .stat-card:hover { border-left-color: var(--green-dark); }

        .stat-card h3 {
            font-size: 2em;
            color: var(--green);
            margin-bottom: 4px;
        }

        .stat-card p {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        /* ‚îÄ‚îÄ SCHEDULE GRID ‚îÄ‚îÄ */
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 2px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .schedule-header {
            background: var(--surface-3);
            color: var(--green);
            padding: 14px;
            text-align: center;
            font-weight: 700;
            font-size: 0.82em;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .schedule-cell {
            background: var(--surface);
            min-height: 100px;
            padding: 10px;
            position: relative;
            transition: background 0.2s ease;
        }

        .schedule-cell:hover { background: var(--surface-2); }

        .schedule-cell.time {
            background: var(--surface-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.82em;
        }

        .schedule-cell.droppable {
            border: 1px dashed var(--border-strong);
            background: var(--green-subtle);
        }

        /* ‚îÄ‚îÄ CLASS CARDS ‚îÄ‚îÄ */
        .class-card {
            background: var(--green-subtle);
            border: 1px solid var(--border-strong);
            color: var(--green);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: move;
            font-size: 0.82em;
            transition: all 0.2s ease;
            position: relative;
        }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--green-glow);
            border-color: var(--green);
        }

        .class-card.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }

        .class-card.individual {
            background: var(--orange-subtle);
            border-color: rgba(255, 152, 0, 0.4);
            color: var(--orange);
        }

        .class-card.prueba {
            background: rgba(255, 179, 71, 0.1);
            border-color: rgba(255, 179, 71, 0.4);
            color: var(--warning);
        }

        .class-card.urgente {
            background: var(--danger-subtle);
            border-color: rgba(255, 85, 85, 0.4);
            color: var(--danger);
        }

        .class-card-header {
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .class-card-body {
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.68em;
            font-weight: 700;
            margin-left: 5px;
            letter-spacing: 0.03em;
        }

        .badge-individual {
            background: var(--orange-subtle);
            color: var(--orange);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .badge-prueba {
            background: var(--green-subtle);
            color: var(--green);
            border: 1px solid var(--border-strong);
        }

        .badge-urgente {
            background: var(--danger-subtle);
            color: var(--danger);
            border: 1px solid rgba(255, 85, 85, 0.3);
        }

        /* ‚îÄ‚îÄ NO-ASSIGNED LIST ‚îÄ‚îÄ */
        .no-assigned-list {
            background: var(--warning-subtle);
            border-left: 3px solid var(--warning);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .no-assigned-item {
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--danger);
        }

        /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(157,255,87,0.05);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-close {
            background: var(--surface-3);
            border: 1px solid var(--border);
            font-size: 1.1em;
            cursor: pointer;
            color: var(--text-muted);
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--text);
            border-color: var(--border-strong);
        }

        /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 7px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.88em;
            letter-spacing: 0.02em;
        }

        label.required::after {
            content: " *";
            color: var(--green);
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 11px 14px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 9px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95em;
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input::placeholder, textarea::placeholder { color: var(--text-dim); }

        select option {
            background: var(--surface-2);
            color: var(--text);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 3px var(--green-subtle);
        }

        /* ‚îÄ‚îÄ HORARIO SLOTS ‚îÄ‚îÄ */
        .grid-horario {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .horario-slot {
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 14px 10px;
            text-align: center;
            border-radius: 9px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.82em;
            color: var(--text-muted);
        }

        .horario-slot.selected {
            background: var(--green-subtle);
            border-color: var(--green);
            color: var(--green);
            font-weight: 700;
        }

        .horario-slot:hover {
            border-color: var(--border-strong);
            color: var(--text);
            transform: translateY(-2px);
        }

        /* ‚îÄ‚îÄ CHECKBOXES ‚îÄ‚îÄ */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .checkbox-label:hover {
            background: var(--surface-3);
            border-color: var(--border-strong);
            color: var(--text);
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--green);
        }

        /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
        .alert {
            padding: 14px 18px;
            border-radius: 9px;
            margin-bottom: 18px;
            font-weight: 500;
            font-size: 0.92em;
        }

        .alert-success {
            background: var(--green-subtle);
            color: var(--green);
            border-left: 3px solid var(--green);
        }

        .alert-warning {
            background: var(--warning-subtle);
            color: var(--warning);
            border-left: 3px solid var(--warning);
        }

        .alert-danger {
            background: var(--danger-subtle);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        .alert-info {
            background: rgba(100, 180, 255, 0.08);
            color: #64B4FF;
            border-left: 3px solid #64B4FF;
        }

        /* ‚îÄ‚îÄ BTN GROUP ‚îÄ‚îÄ */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* ‚îÄ‚îÄ SOLICITUD CARDS ‚îÄ‚îÄ */
        .solicitud-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 14px;
            transition: all 0.2s ease;
            color: var(--text);
        }

        .solicitud-card:hover {
            border-color: var(--border-strong);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .solicitud-card.prueba {
            border-left: 4px solid var(--green);
            background: linear-gradient(90deg, var(--green-subtle), var(--surface-2));
        }

        .solicitud-card.urgente {
            border-left: 4px solid var(--danger);
            background: linear-gradient(90deg, var(--danger-subtle), var(--surface-2));
        }

        /* ‚îÄ‚îÄ PROFESOR CARDS ‚îÄ‚îÄ */
        .profesor-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 14px;
            color: var(--text);
        }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 3.5em;
            margin-bottom: 16px;
            opacity: 0.25;
        }

        /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
        .loading {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2px solid rgba(157,255,87,0.2);
            border-radius: 50%;
            border-top-color: var(--green);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ CONFIRMED BADGE ‚îÄ‚îÄ */
        .confirmed-badge {
            display: inline-block;
            background: var(--green-subtle);
            color: var(--green);
            border: 1px solid var(--border-strong);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85em;
            margin-left: 10px;
        }

        /* ‚îÄ‚îÄ DRAG HANDLE ‚îÄ‚îÄ */
        .drag-handle {
            cursor: grab;
            padding: 4px;
            margin-right: 4px;
            opacity: 0.5;
        }

        .drag-handle:active { cursor: grabbing; }

        /* ‚îÄ‚îÄ EDIT CONTROLS ‚îÄ‚îÄ */
        .edit-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .edit-btn {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 4px 9px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.72em;
            color: inherit;
            font-weight: 600;
            transition: background 0.15s;
        }

        .edit-btn:hover { background: rgba(255,255,255,0.14); }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .schedule-grid {
                grid-template-columns: 56px repeat(5, 1fr);
                font-size: 0.78em;
            }

            .stats-grid { grid-template-columns: 1fr 1fr; }

            .tabs { font-size: 0.85em; }

            .container { padding: 18px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1><span class="not">not</span>Dumb</h1>
            <p>tu gimnasio de estudio</p>
            <span class="version-badge">v6.2 - Algoritmo Optimizado</span>
        </div>

        <!-- Pantalla Inicial -->
        <div id="screen-inicial" class="screen active">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--text);">Bienvenido al Planificador</h2>
            <div class="btn-group" style="justify-content: center;">
                <button class="btn" onclick="mostrarScreen('screen-login-alumno')">Soy Alumno</button>
                <button class="btn btn-secondary" onclick="mostrarScreen('screen-login-admin')">Soy Administrador</button>
            </div>
        </div>

        <!-- Login Alumno -->
        <div id="screen-login-alumno" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Acceso de Alumno</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="mostrarTab('tab-login')">Iniciar Sesi√≥n</button>
                <button class="tab" onclick="mostrarTab('tab-registro')">Registrarse</button>
            </div>

            <div id="tab-login" class="tab-content active">
                <div class="form-group">
                    <label class="required">Email:</label>
                    <input type="email" id="login-email-alumno" placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label class="required">Nombre:</label>
                    <input type="text" id="login-nombre-alumno" placeholder="Tu nombre">
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="loginAlumno()">Iniciar Sesi√≥n</button>
                    <button class="btn btn-secondary" onclick="mostrarScreen('screen-inicial')">Volver</button>
                </div>
            </div>

            <div id="tab-registro" class="tab-content">
                <div class="form-group">
                    <label class="required">Nombre:</label>
                    <input type="text" id="reg-nombre" placeholder="Tu nombre">
                </div>
                <div class="form-group">
                    <label class="required">Apellidos:</label>
                    <input type="text" id="reg-apellidos" placeholder="Tus apellidos">
                </div>
                <div class="form-group">
                    <label class="required">Email:</label>
                    <input type="email" id="reg-email" placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label class="required">Curso:</label>
                    <select id="reg-curso" onchange="toggleOtroCurso()">
                        <option value="">Selecciona tu curso</option>
                        <option value="1¬∫ Bachillerato">1¬∫ Bachillerato</option>
                        <option value="2¬∫ Bachillerato / Selectividad">2¬∫ Bachillerato / Selectividad</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div id="otro-curso-field" class="form-group" style="display: none;">
                    <label>Especifica tu curso:</label>
                    <input type="text" id="reg-otro-curso" placeholder="Ej: 4¬∫ ESO, Universidad...">
                    <small style="color: var(--text-muted);">Nos pondremos en contacto contigo para adaptar las clases.</small>
                </div>
                <div class="form-group">
                    <label class="required">Comunidad Aut√≥noma:</label>
                    <input type="text" id="reg-comunidad" placeholder="Ej: Catalu√±a, Madrid...">
                </div>
                <div class="form-group">
                    <label>Provincia:</label>
                    <input type="text" id="reg-provincia" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label>Ciudad:</label>
                    <input type="text" id="reg-ciudad" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label>Instituto:</label>
                    <input type="text" id="reg-instituto" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="menor-edad" onchange="toggleMinorFields()">
                        Soy menor de edad
                    </label>
                </div>
                <div id="minor-fields" style="display: none;">
                    <div class="form-group">
                        <label class="required">Nombre del Tutor Legal:</label>
                        <input type="text" id="tutor-nombre" placeholder="Nombre completo del tutor">
                    </div>
                    <div class="form-group">
                        <label class="required">Email del Tutor Legal:</label>
                        <input type="email" id="tutor-email" placeholder="email@tutor.com">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="registrarAlumno()">Registrarse</button>
                    <button class="btn btn-secondary" onclick="mostrarScreen('screen-inicial')">Volver</button>
                </div>
            </div>
        </div>

        <!-- Opciones Alumno Nuevo -->
        <div id="screen-opciones-nuevo" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">¬°Bienvenido!</h2>
            <p style="margin-bottom: 30px; color: var(--text-muted);">Como eres nuevo, puedes elegir entre estas opciones:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="solicitud-card prueba" style="cursor: pointer;" onclick="iniciarSolicitudPrueba()">
                    <h3 style="color: #48ed83; margin-bottom: 10px;">üéØ 1¬™ Clase de Prueba Gratuita</h3>
                    <p style="color: var(--text-muted);">Experimenta una clase sin compromiso</p>
                </div>
                <div class="solicitud-card" style="cursor: pointer;" onclick="mostrarHorarioPublicado()">
                    <h3 style="color: var(--text); margin-bottom: 10px;">üìÖ Unirme a una Clase del Horario</h3>
                    <p style="color: var(--text-muted);">Ver horario publicado y solicitar unirme</p>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Opciones Alumno Recurrente -->
        <div id="screen-opciones-recurrente" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">¬°Bienvenido de nuevo!</h2>
            <p style="margin-bottom: 30px; color: var(--text-muted);">¬øQu√© deseas hacer hoy?</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="solicitud-card" style="cursor: pointer;" onclick="iniciarSolicitud()">
                    <h3 style="color: var(--text); margin-bottom: 10px;">üìö Necesito Clase</h3>
                    <p style="color: var(--text-muted);">Solicitar nuevas clases</p>
                </div>
                <div class="solicitud-card" style="cursor: pointer;" onclick="noNecesitoClase()">
                    <h3 style="color: var(--text); margin-bottom: 10px;">‚úÖ No Necesito Clase</h3>
                    <p style="color: var(--text-muted);">No necesito clases por ahora</p>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Formulario de Solicitud (pasos 1-5 igual que antes) -->
        <!-- Paso 1: Disponibilidad -->
        <div id="screen-disponibilidad" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Marca tu Disponibilidad Horaria</h2>
            <p style="margin-bottom: 20px; color: var(--text-muted);">Selecciona TODOS los horarios en los que podr√≠as tener clase. Cuantos m√°s marques, m√°s f√°cil ser√° agruarte con otros estudiantes.</p>
            
            <div class="grid-horario">
                <div style="grid-column: 1 / -1; text-align: center; padding: 15px; background: var(--surface-3); color: var(--green); font-weight: 700; border-radius: 8px 8px 0 0; border: 1px solid var(--border); letter-spacing: 0.04em;">
                    Lunes a Viernes - 16:00 a 20:00
                </div>
            </div>
            <div id="disponibilidad-grid" class="grid-horario"></div>

            <div class="btn-group">
                <button class="btn" onclick="siguientePaso('screen-disponibilidad', 'screen-asignatura')">Siguiente</button>
                <button class="btn btn-secondary" onclick="volverOpcionesAlumno()">Volver</button>
            </div>
        </div>

        <!-- Paso 2: Asignatura -->
        <div id="screen-asignatura" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Selecciona la Asignatura</h2>
            <div class="form-group">
                <label class="required">Asignatura:</label>
                <select id="asignatura-select" onchange="cargarTemas()">
                    <option value="">Selecciona una asignatura</option>
                    <option value="Matem√°ticas">Matem√°ticas</option>
                    <option value="F√≠sica">F√≠sica</option>
                    <option value="Qu√≠mica">Qu√≠mica</option>
                    <option value="Biolog√≠a">Biolog√≠a</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="siguientePaso('screen-asignatura', 'screen-temas')">Siguiente</button>
                <button class="btn btn-secondary" onclick="siguientePaso('screen-asignatura', 'screen-disponibilidad')">Atr√°s</button>
            </div>
        </div>

        <!-- Paso 3: Temas -->
        <div id="screen-temas" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Selecciona los Temas</h2>
            <div id="temas-container"></div>
            <div class="btn-group">
                <button class="btn" onclick="siguientePaso('screen-temas', 'screen-subtemas')">Siguiente</button>
                <button class="btn btn-secondary" onclick="siguientePaso('screen-temas', 'screen-asignatura')">Atr√°s</button>
            </div>
        </div>

        <!-- Paso 4: Subtemas y Detalles -->
        <div id="screen-subtemas" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Detalles de la Clase</h2>
            <div id="subtemas-container"></div>
            
            <div class="form-group">
                <label class="required">Nivel Actual:</label>
                <select id="nivel-clase">
                    <option value="0">Desde 0 - Necesito empezar desde lo m√°s b√°sico</option>
                    <option value="1">1 - Muy bajo</option>
                    <option value="2">2 - Bajo</option>
                    <option value="3">3 - Medio-Bajo</option>
                    <option value="4">4 - Medio</option>
                    <option value="5">5 - Repaso General - tengo dudas finales antes del examen</option>
                    <option value="6">6 - Medio-Alto</option>
                    <option value="7">7 - Alto</option>
                    <option value="8">8 - Muy Alto</option>
                    <option value="9">9 - Excelente</option>
                    <option value="10">10 - Necesito hacer ejercicios</option>
                </select>
            </div>

            <div class="form-group">
                <label class="required">¬øCu√°ntas horas de clase quieres para este tema?</label>
                <input type="number" id="horas-clase" min="1" max="10" value="2">
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                    Cada hora ser√° en una franja horaria diferente para maximizar tu aprendizaje
                </small>
            </div>

            <div class="form-group">
                <label>¬øTienes examen pr√≥ximamente?</label>
                <input type="date" id="fecha-examen">
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                    Si tu examen es en menos de 7 d√≠as, tu solicitud ser√° prioritaria
                </small>
            </div>

            <div class="form-group">
                <label>Tipo de Clase (puedes seleccionar varios):</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" value="Teor√≠a" class="tipo-clase-check">
                        Teor√≠a
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Ejercicios" class="tipo-clase-check" checked>
                        Ejercicios
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Ex√°menes" class="tipo-clase-check">
                        Resoluci√≥n de Ex√°menes
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="Dudas" class="tipo-clase-check">
                        Resolver Dudas
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Comentarios adicionales:</label>
                <textarea id="comentarios-clase" rows="3" placeholder="Cualquier informaci√≥n adicional que quieras compartir..."></textarea>
            </div>

            <div class="form-group">
                <label>Adjuntar Apuntes/Materiales (opcional):</label>
                <input type="file" id="archivo-clase" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                    Puedes adjuntar apuntes, ejercicios, ex√°menes, etc.
                </small>
            </div>

            <div class="btn-group">
                <button class="btn" onclick="guardarTema()">Guardar y Continuar</button>
                <button class="btn btn-secondary" onclick="siguientePaso('screen-subtemas', 'screen-temas')">Atr√°s</button>
            </div>
        </div>

        <!-- Paso 5: Confirmaci√≥n -->
        <div id="screen-confirmacion" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Resumen de tu Solicitud</h2>
            <div id="resumen-solicitud"></div>
            <div class="btn-group">
                <button class="btn" onclick="solicitarOtraTema()">Solicitar Otra Asignatura</button>
                <button class="btn btn-secondary" onclick="finalizarSolicitud()">Finalizar Solicitud</button>
            </div>
        </div>

        <!-- Pantalla de Gracias -->
        <div id="screen-gracias" class="screen">
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: #48ed83; margin-bottom: 20px;">¬°Solicitud Enviada!</h2>
                <p style="color: var(--text-muted); font-size: 1.1em; margin-bottom: 30px;">
                    Hemos recibido tu solicitud correctamente. Te contactaremos pronto con la planificaci√≥n de tus clases.
                </p>
                <button class="btn" onclick="cerrarSesion()">Cerrar</button>
            </div>
        </div>

        <!-- Login Admin -->
        <div id="screen-login-admin" class="screen">
            <h2 style="margin-bottom: 20px; color: var(--text);">Acceso de Administrador</h2>
            <div class="form-group">
                <label class="required">Contrase√±a:</label>
                <input type="password" id="password-admin" placeholder="Contrase√±a de administrador">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="loginAdmin()">Iniciar Sesi√≥n</button>
                <button class="btn btn-secondary" onclick="mostrarScreen('screen-inicial')">Volver</button>
            </div>
        </div>

        <!-- Dashboard Admin -->
        <div id="screen-dashboard" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--text);">Dashboard de Administraci√≥n</h2>
                <div>
                    <span id="horario-confirmado-badge" class="confirmed-badge" style="display: none;">
                        ‚úì Horario Confirmado
                    </span>
                    <button class="btn btn-danger" onclick="cerrarSesionAdmin()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="mostrarTabAdmin('tab-solicitudes')">Solicitudes</button>
                <button class="tab" onclick="mostrarTabAdmin('tab-planificacion')">Planificaci√≥n</button>
                <button class="tab" onclick="mostrarTabAdmin('tab-profesores')">Profesores</button>
                <button class="tab" onclick="mostrarTabAdmin('tab-exportar')">Exportar</button>
            </div>

            <!-- Tab Solicitudes -->
            <div id="tab-solicitudes" class="tab-content active">
                <div class="stats-grid" id="stats-solicitudes"></div>
                <div id="lista-solicitudes"></div>
            </div>

            <!-- Tab Planificaci√≥n -->
            <div id="tab-planificacion" class="tab-content">
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn" onclick="generarPlanificacion()">
                        <span id="btn-planificar-text">üöÄ Generar Planificaci√≥n Autom√°tica</span>
                        <span id="btn-planificar-loading" class="loading" style="display: none;"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarModalA√±adirClase()">‚ûï A√±adir Clase Manual</button>
                    <button class="btn btn-danger" onclick="limpiarPlanificacion()">üóëÔ∏è Limpiar Planificaci√≥n</button>
                </div>

                <div id="alerta-planificacion"></div>

                <!-- Estad√≠sticas de Planificaci√≥n -->
                <div class="stats-grid" id="stats-planificacion" style="display: none;"></div>

                <!-- No Asignados -->
                <div id="seccion-no-asignados" style="display: none;">
                    <h3 style="color: #dc3545; margin: 20px 0 10px 0;">‚ö†Ô∏è Alumnos Sin Clase Asignada</h3>
                    <div id="lista-no-asignados"></div>
                </div>

                <!-- Horario Semanal -->
                <div id="horario-semanal" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                        <h3 style="color: var(--text);">üìÖ Horario Semanal</h3>
                        <button class="btn btn-secondary" onclick="confirmarHorario()">
                            ‚úì Confirmar y Enviar Horario
                        </button>
                    </div>
                    <div class="schedule-grid" id="schedule-grid"></div>
                </div>
            </div>

            <!-- Tab Profesores -->
            <div id="tab-profesores" class="tab-content">
                <button class="btn" onclick="mostrarModalProfesor()" style="margin-bottom: 20px;">‚ûï A√±adir Profesor</button>
                <div id="lista-profesores"></div>
            </div>

            <!-- Tab Exportar -->
            <div id="tab-exportar" class="tab-content">
                <h3 style="margin-bottom: 20px; color: var(--text);">Exportar Planificaci√≥n</h3>
                <div class="btn-group">
                    <button class="btn" onclick="exportarExcel()">
                        üìä Exportar a Excel
                    </button>
                    <button class="btn" onclick="exportarPNG()">
                        üñºÔ∏è Exportar como Imagen (PNG)
                    </button>
                </div>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>Nota:</strong> La exportaci√≥n a Excel incluye varias hojas con toda la informaci√≥n detallada. La imagen PNG es ideal para compartir en redes sociales.
                </div>
            </div>
        </div>

        <!-- Modal A√±adir Profesor -->
        <div id="modal-profesor" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>A√±adir Profesor</h3>
                    <button class="modal-close" onclick="cerrarModal('modal-profesor')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="required">Nombre:</label>
                    <input type="text" id="profesor-nombre" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label class="required">Materias que imparte:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" value="Matem√°ticas" class="materia-check">
                            Matem√°ticas
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="F√≠sica" class="materia-check">
                            F√≠sica
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="Qu√≠mica" class="materia-check">
                            Qu√≠mica
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="Biolog√≠a" class="materia-check">
                            Biolog√≠a
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Disponibilidad Horaria:</label>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">Selecciona los horarios disponibles</p>
                    <div id="profesor-disponibilidad-grid" class="grid-horario"></div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="guardarProfesor()">Guardar</button>
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-profesor')">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal A√±adir Clase Manual -->
        <div id="modal-a√±adir-clase" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>A√±adir Clase Manual</h3>
                    <button class="modal-close" onclick="cerrarModal('modal-a√±adir-clase')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="required">Curso:</label>
                    <select id="manual-curso">
                        <option value="1¬∫ Bachillerato">1¬∫ Bachillerato</option>
                        <option value="2¬∫ Bachillerato / Selectividad">2¬∫ Bachillerato / Selectividad</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required">Asignatura:</label>
                    <select id="manual-asignatura">
                        <option value="Matem√°ticas">Matem√°ticas</option>
                        <option value="F√≠sica">F√≠sica</option>
                        <option value="Qu√≠mica">Qu√≠mica</option>
                        <option value="Biolog√≠a">Biolog√≠a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required">Tema:</label>
                    <input type="text" id="manual-tema" placeholder="Ej: Derivadas">
                </div>
                <div class="form-group">
                    <label class="required">Subtema:</label>
                    <input type="text" id="manual-subtema" placeholder="Ej: Regla de la cadena">
                </div>
                <div class="form-group">
                    <label class="required">Profesor:</label>
                    <select id="manual-profesor"></select>
                </div>
                <div class="form-group">
                    <label class="required">D√≠a y Hora:</label>
                    <select id="manual-slot"></select>
                </div>
                <div class="form-group">
                    <label>Alumnos (opcional - puedes a√±adirlos despu√©s):</label>
                    <select id="manual-alumnos" multiple style="height: 150px;"></select>
                    <small style="color: var(--text-muted);">Mant√©n Ctrl (Cmd en Mac) para seleccionar varios</small>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="guardarClaseManual()">A√±adir Clase</button>
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-a√±adir-clase')">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal Detalles de Clase -->
        <div id="modal-detalle-clase" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Detalles de la Clase</h3>
                    <button class="modal-close" onclick="cerrarModal('modal-detalle-clase')">&times;</button>
                </div>
                <div id="detalle-clase-contenido"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="mostrarModalEditarAlumnos()">‚úèÔ∏è Editar Alumnos</button>
                    <button class="btn btn-danger" onclick="eliminarClaseActual()">üóëÔ∏è Eliminar Clase</button>
                    <button class="btn" onclick="cerrarModal('modal-detalle-clase')">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Modal Editar Alumnos de Clase -->
        <div id="modal-editar-alumnos" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Alumnos de la Clase</h3>
                    <button class="modal-close" onclick="cerrarModal('modal-editar-alumnos')">&times;</button>
                </div>
                <div class="form-group">
                    <label>Alumnos Actuales:</label>
                    <div id="lista-alumnos-actuales"></div>
                </div>
                <div class="form-group">
                    <label>A√±adir Alumnos:</label>
                    <select id="select-a√±adir-alumnos" multiple style="height: 150px;"></select>
                    <small style="color: var(--text-muted);">Mant√©n Ctrl (Cmd en Mac) para seleccionar varios</small>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="guardarEdicionAlumnos()">Guardar Cambios</button>
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-editar-alumnos')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============== VARIABLES GLOBALES ==============
        let estudiantes = JSON.parse(localStorage.getItem('estudiantes')) || [];
        let profesores = JSON.parse(localStorage.getItem('profesores')) || [
            {
                id: 1,
                nombre: 'Prof. Garc√≠a',
                materias: ['Matem√°ticas', 'F√≠sica'],
                disponibilidad: generarTodosLosSlots()
            },
            {
                id: 2,
                nombre: 'Prof. Mart√≠nez',
                materias: ['Qu√≠mica', 'Biolog√≠a'],
                disponibilidad: generarTodosLosSlots()
            }
        ];
        let clasesPlanificadas = [];
        let estudiantesNoAsignados = [];
        let estudianteActual = null;
        let claseActual = null;
        let horarioConfirmado = false;

        const DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
        const HORAS = ['16:00', '17:00', '18:00', '19:00', '20:00'];

        // TEMARIOS COMPLETOS (mantener estructura original)
        const TEMARIOS = {
            // [MANTENER TODOS LOS TEMARIOS EXACTAMENTE IGUAL QUE EN LA VERSI√ìN ANTERIOR]
            'Matem√°ticas': {
                '1¬∫ Bachillerato': {
                    'Sentido Num√©rico': ['N√∫meros Reales', 'Radicales y Potencias', 'Logaritmos', 'N√∫meros Complejos'],
                    'Sentido Algebraico': ['Polinomios', 'Ecuaciones', 'Sistemas de Ecuaciones', 'Inecuaciones'],
                    'Sentido de la Medida y Espacial': ['Trigonometr√≠a', 'Tri√°ngulos', 'Vectores en el Plano', 'Geometr√≠a Anal√≠tica'],
                    'Sentido de las Funciones': ['Funciones Elementales', 'L√≠mites y Continuidad', 'Derivadas', 'Aplicaci√≥n de Derivadas'],
                    'Estad√≠stica y Probabilidad': ['Estad√≠stica Bidimensional', 'Probabilidad', 'Distribuci√≥n Binomial', 'Distribuci√≥n Normal']
                },
                '2¬∫ Bachillerato / Selectividad': {
                    'An√°lisis (funciones, l√≠mites, continuidad, derivadas, integrales)': [
                        'L√≠mites y continuidad',
                        'As√≠ntotas',
                        'Teorema de Bolzano',
                        'Aprender a derivar',
                        'Optimizaci√≥n',
                        'Representaci√≥n completa funciones (monoton√≠a y curvatura)',
                        'Aprender a integrar desde 0',
                        'Integrar por partes y por sustituci√≥n',
                        'Integrales definidas con c√°lculo de √°reas'
                    ],
                    '√Ålgebra Lineal (Matrices, Sistemas de ecuaciones, Vectores)': [
                        'Operaciones con matrices',
                        'Rango-matriz inversa y ecuaciones matriciales (AX=B)',
                        'Determinantes',
                        'Sistemas de ecuaciones',
                        'Introducci√≥n vectores-producto escalar-√°ngulo',
                        'Combinaci√≥n lineal-bases-producto mixto'
                    ],
                    'Geometr√≠a (rectas y planos)': [
                        'Ecuaciones de rectas y posiciones relativas',
                        'Ecuaciones de planos y posiciones relativas',
                        '√Ångulos entre rectas y planos',
                        'Distancias entre rectas y planos'
                    ],
                    'Probabilidad': [
                        'F√≥rmulas de probabilidad y diagramas de √°rbol',
                        'Distribuci√≥n binomial',
                        'Distribuci√≥n normal',
                        'Estad√≠stica'
                    ]
                }
            },
            'F√≠sica': {
                '2¬∫ Bachillerato / Selectividad': {
                    'Magnitudes y vectores': ['Magnitudes f√≠sicas y vectores', 'Operaciones con vectores'],
                    'Mec√°nica (cinem√°tica, din√°mica, trabajo y energ√≠a)': ['Cinem√°tica', 'Din√°mica y leyes de Newton', 'Trabajo', 'Energ√≠a mec√°nica'],
                    'Campo gravitatorio': ['Ley de gravitaci√≥n universal', 'Campo gravitatorio', 'Energ√≠a potencial gravitatoria', 'Sat√©lites y √≥rbitas'],
                    'Campo el√©ctrico': ['Ley de Coulomb', 'Campo el√©ctrico', 'Potencial el√©ctrico', 'Condensadores'],
                    'Campo magn√©tico': ['Campo magn√©tico', 'Fuerza de Lorentz', 'Fuerza magn√©tica sobre corrientes'],
                    'Inducci√≥n electromagn√©tica': ['Flujo magn√©tico', 'Ley de Faraday-Lenz', 'Generadores y motores'],
                    'Movimiento arm√≥nico simple': ['Ecuaci√≥n del MAS', 'Energ√≠a en el MAS', 'P√©ndulos y muelles'],
                    'Ondas': ['Tipos de ondas', 'Ecuaci√≥n de ondas', 'Interferencias y difracci√≥n'],
                    'Luz y espectro electromagn√©tico': ['Naturaleza de la luz', 'Espectro electromagn√©tico', 'Fotometr√≠a'],
                    'Espejos y lentes': ['Reflexi√≥n y espejos', 'Refracci√≥n y lentes', 'Instrumentos √≥pticos'],
                    'F√≠sica moderna (E=mc¬≤)': ['Relatividad especial', 'Equivalencia masa-energ√≠a'],
                    'F√≠sica cu√°ntica (efecto fotoel√©ctrico y modelos at√≥micos)': ['Efecto fotoel√©ctrico', 'Modelo de Bohr', 'Dualidad onda-corp√∫sculo'],
                    'F√≠sica nuclear (radioactividad y reacciones nucleares)': ['Estructura nuclear', 'Radioactividad', 'Reacciones nucleares']
                }
            },
            'Qu√≠mica': {
                '2¬∫ Bachillerato / Selectividad': {
                    'Formulaci√≥n inorg√°nica': ['Compuestos binarios', 'Compuestos ternarios'],
                    'Formulaci√≥n org√°nica': ['Introducci√≥n cadenas-alquenos-alquinos', 'Grupos funcionales (alcoholes, √°cidos, etc.)'],
                    'El √°tomo': ['Estructura at√≥mica Z y A', 'N√∫meros cu√°nticos-configuraci√≥n electr√≥nica-localizaci√≥n tabla peri√≥dica-orbitales'],
                    'Propiedades de la tabla peri√≥dica': ['Radio at√≥mico e i√≥nico', 'Energ√≠a de ionizaci√≥n', 'Afinidad electr√≥nica', 'Electronegatividad'],
                    'Enlace qu√≠mico': ['Enlace i√≥nico', 'Enlace covalente', 'Geometr√≠a molecular y fuerzas intermoleculares'],
                    'Estequiometr√≠a-disoluciones-gases': ['Leyes ponderales', 'Estequiometr√≠a', 'Reactivo limitante', 'Disoluciones', 'Gases ideales'],
                    'Termoqu√≠mica': ['Entalp√≠a', 'Ley de Hess', 'Entalp√≠a de enlace', 'Entrop√≠a', 'Energ√≠a de Gibbs'],
                    'Cin√©tica': ['Velocidad de reacci√≥n', 'Ecuaci√≥n de velocidad', 'Energ√≠a de activaci√≥n'],
                    'Equilibrio qu√≠mico': ['Constante de equilibrio', 'Principio de Le Chatelier', 'Grado de disociaci√≥n'],
                    'Equilibrio √°cido-base': ['Teor√≠as √°cido-base', 'pH y pOH', 'Hidr√≥lisis', 'Disoluciones reguladoras'],
                    'Equilibrio de solubilidad y precipitaci√≥n': ['Producto de solubilidad', 'Precipitaci√≥n'],
                    'REDOX': ['N√∫mero de oxidaci√≥n', 'Ajuste de reacciones REDOX', 'Pilas electroqu√≠micas'],
                    'Qu√≠mica del carbono': ['Hidrocarburos', 'Grupos funcionales', 'Isomer√≠a']
                }
            },
            'Biolog√≠a': {
                '1¬∫ Bachillerato': {
                    'Base Molecular (Bioqu√≠mica)': ['Bioelementos y Biomol√©culas', 'Gl√∫cidos', 'L√≠pidos', 'Prote√≠nas', '√Åcidos Nucleicos'],
                    'La C√©lula': ['Teor√≠a Celular', 'Tipos de C√©lulas', 'Estructuras Celulares', 'Membrana y Transporte'],
                    'Gen√©tica y Evoluci√≥n': ['Leyes de Mendel', 'Herencia', 'Mutaciones', 'Teor√≠as Evolutivas'],
                    'Histolog√≠a y Fisiolog√≠a': ['Tejidos Animales y Vegetales', 'Sistemas del Cuerpo Humano'],
                    'Ecolog√≠a y Sostenibilidad': ['Ecosistemas', 'Ciclos Biogeoqu√≠micos', 'Impacto Ambiental']
                },
                '2¬∫ Bachillerato / Selectividad': {
                    'Biomol√©culas': ['Agua-sales minerales', 'Gl√∫cidos y l√≠pidos', 'Prote√≠nas y enzimas', '√Åcidos nucleicos'],
                    'La c√©lula': ['Estructuras', 'Membranas y org√°nulos'],
                    'Reproducci√≥n celular': ['Mitosis', 'Meiosis', 'Ciclo celular'],
                    'Metabolismo': ['Anabolismo', 'Catabolismo'],
                    'Gen√©tica mendeliana': ['Leyes de Mendel', 'Herencia ligada al sexo', 'Teor√≠a cromos√≥mica'],
                    'Gen√©tica molecular': ['Replicaci√≥n del ADN', 'Transcripci√≥n', 'Traducci√≥n', 'Mutaciones'],
                    'Microorganismos': ['Bacterias', 'Virus', 'Biotecnolog√≠a'],
                    'Inmunolog√≠a': ['Sistema inmunitario', 'Respuesta inmune', 'Inmunidad y vacunas']
                }
            }
        };

        // ============== FUNCIONES DE NAVEGACI√ìN ==============
        function mostrarScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function mostrarTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function mostrarTabAdmin(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'tab-solicitudes') actualizarSolicitudes();
            if (tabId === 'tab-profesores') actualizarProfesores();
        }

        function siguientePaso(actualScreen, siguienteScreen) {
            mostrarScreen(siguienteScreen);
        }

        // ============== FUNCIONES DE AUTENTICACI√ìN ==============
        function loginAdmin() {
            const password = document.getElementById('password-admin').value;
            if (password === 'admin2025') {
                mostrarScreen('screen-dashboard');
                actualizarSolicitudes();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function cerrarSesionAdmin() {
            mostrarScreen('screen-inicial');
        }

        function loginAlumno() {
            const email = document.getElementById('login-email-alumno').value.trim();
            const nombre = document.getElementById('login-nombre-alumno').value.trim();
            
            if (!email || !nombre) {
                alert('Por favor, completa todos los campos');
                return;
            }

            const estudiante = estudiantes.find(e => 
                e.email.toLowerCase() === email.toLowerCase() && 
                e.nombre.toLowerCase().includes(nombre.toLowerCase())
            );

            if (estudiante) {
                estudianteActual = estudiante;
                if (estudiante.esNuevo) {
                    mostrarScreen('screen-opciones-nuevo');
                } else {
                    mostrarScreen('screen-opciones-recurrente');
                }
            } else {
                alert('No se encontr√≥ ning√∫n estudiante con esos datos. Por favor, reg√≠strate primero.');
            }
        }

        function registrarAlumno() {
            const nombre = document.getElementById('reg-nombre').value.trim();
            const apellidos = document.getElementById('reg-apellidos').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            let curso = document.getElementById('reg-curso').value;
            const comunidad = document.getElementById('reg-comunidad').value.trim();
            const provincia = document.getElementById('reg-provincia').value.trim();
            const ciudad = document.getElementById('reg-ciudad').value.trim();
            const instituto = document.getElementById('reg-instituto').value.trim();
            const menorEdad = document.getElementById('menor-edad').checked;
            const tutorNombre = document.getElementById('tutor-nombre').value.trim();
            const tutorEmail = document.getElementById('tutor-email').value.trim();

            if (!nombre || !apellidos || !email || !curso || !comunidad) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            if (curso === 'Otro') {
                const otroCurso = document.getElementById('reg-otro-curso').value.trim();
                if (!otroCurso) {
                    alert('Por favor, especifica tu curso');
                    return;
                }
                curso = `Otro: ${otroCurso}`;
            }

            if (menorEdad && (!tutorNombre || !tutorEmail)) {
                alert('Por favor, completa los datos del tutor legal');
                return;
            }

            if (estudiantes.some(e => e.email === email)) {
                alert('Ya existe un estudiante con ese email');
                return;
            }

            const nuevoEstudiante = {
                id: Date.now(),
                nombre: `${nombre} ${apellidos}`,
                email: email,
                curso: curso,
                comunidad: comunidad,
                provincia: provincia,
                ciudad: ciudad,
                instituto: instituto,
                menorEdad: menorEdad,
                tutorNombre: tutorNombre || null,
                tutorEmail: tutorEmail || null,
                disponibilidad: [],
                temas: [],
                esNuevo: true,
                tienePrueba: false,
                fechaRegistro: new Date().toISOString()
            };

            estudiantes.push(nuevoEstudiante);
            guardarEstudiantes();
            alert('Registro exitoso. Ahora puedes iniciar sesi√≥n.');
            mostrarTab('tab-login');
        }

        function toggleOtroCurso() {
            const curso = document.getElementById('reg-curso').value;
            const otroCursoField = document.getElementById('otro-curso-field');
            otroCursoField.style.display = curso === 'Otro' ? 'block' : 'none';
        }

        function toggleMinorFields() {
            const menorEdad = document.getElementById('menor-edad').checked;
            document.getElementById('minor-fields').style.display = menorEdad ? 'block' : 'none';
        }

        function cerrarSesion() {
            estudianteActual = null;
            mostrarScreen('screen-inicial');
        }

        function volverOpcionesAlumno() {
            if (estudianteActual.esNuevo) {
                mostrarScreen('screen-opciones-nuevo');
            } else {
                mostrarScreen('screen-opciones-recurrente');
            }
        }

        // ============== FLUJOS DE SOLICITUD ==============
        function iniciarSolicitudPrueba() {
            iniciarDisponibilidad();
            mostrarScreen('screen-disponibilidad');
        }

        function iniciarSolicitud() {
            iniciarDisponibilidad();
            mostrarScreen('screen-disponibilidad');
        }

        function noNecesitoClase() {
            alert('¬°Perfecto! Nos vemos pronto.');
            cerrarSesion();
        }

        function mostrarHorarioPublicado() {
            // Esta funci√≥n mostrar√≠a el horario publicado
            alert('Funcionalidad de horario publicado - Por implementar con integraci√≥n');
            volverOpcionesAlumno();
        }

        // ============== DISPONIBILIDAD HORARIA ==============
        function iniciarDisponibilidad() {
            const grid = document.getElementById('disponibilidad-grid');
            grid.innerHTML = '';
            
            HORAS.forEach(hora => {
                DIAS.forEach(dia => {
                    const slot = `${dia}-${hora}`;
                    const div = document.createElement('div');
                    div.className = 'horario-slot';
                    div.textContent = `${dia.substring(0, 3)}\n${hora}`;
                    div.onclick = () => toggleDisponibilidad(div, slot);
                    
                    if (estudianteActual.disponibilidad.includes(slot)) {
                        div.classList.add('selected');
                    }
                    
                    grid.appendChild(div);
                });
            });
        }

        function toggleDisponibilidad(elemento, slot) {
            elemento.classList.toggle('selected');
            if (estudianteActual.disponibilidad.includes(slot)) {
                estudianteActual.disponibilidad = estudianteActual.disponibilidad.filter(s => s !== slot);
            } else {
                estudianteActual.disponibilidad.push(slot);
            }
            guardarEstudiantes();
        }

        // ============== SELECCI√ìN DE ASIGNATURA Y TEMAS ==============
        function cargarTemas() {
            const asignatura = document.getElementById('asignatura-select').value;
            if (!asignatura) return;

            const curso = estudianteActual.curso;
            const temas = TEMARIOS[asignatura]?.[curso] || {};
            
            const container = document.getElementById('temas-container');
            container.innerHTML = '<div class="checkbox-group"></div>';
            const checkboxGroup = container.querySelector('.checkbox-group');

            Object.keys(temas).forEach(tema => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" value="${tema}" class="tema-check">
                    ${tema}
                `;
                checkboxGroup.appendChild(label);
            });
        }

        function cargarSubtemas() {
            const asignatura = document.getElementById('asignatura-select').value;
            const temasSeleccionados = Array.from(document.querySelectorAll('.tema-check:checked'))
                .map(cb => cb.value);
            
            if (temasSeleccionados.length === 0) {
                alert('Selecciona al menos un tema');
                return false;
            }

            const curso = estudianteActual.curso;
            const container = document.getElementById('subtemas-container');
            container.innerHTML = '';

            temasSeleccionados.forEach(tema => {
                const subtemas = TEMARIOS[asignatura][curso][tema] || [];
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label class="required">${tema}:</label>
                    <div class="checkbox-group" id="subtemas-${tema.replace(/\s+/g, '-')}"></div>
                `;
                container.appendChild(div);

                const subtemasGroup = div.querySelector('.checkbox-group');
                subtemas.forEach(subtema => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-label';
                    label.innerHTML = `
                        <input type="checkbox" value="${subtema}" class="subtema-check" data-tema="${tema}">
                        ${subtema}
                    `;
                    subtemasGroup.appendChild(label);
                });
            });

            return true;
        }

        function guardarTema() {
            const asignatura = document.getElementById('asignatura-select').value;
            const temasSeleccionados = Array.from(document.querySelectorAll('.tema-check:checked'))
                .map(cb => cb.value);
            const subtemasSeleccionados = Array.from(document.querySelectorAll('.subtema-check:checked'))
                .map(cb => ({ tema: cb.dataset.tema, subtema: cb.value }));
            
            if (subtemasSeleccionados.length === 0) {
                alert('Selecciona al menos un subtema');
                return;
            }

            const nivel = parseInt(document.getElementById('nivel-clase').value);
            const horas = parseInt(document.getElementById('horas-clase').value);
            const fechaExamen = document.getElementById('fecha-examen').value;
            const tiposClase = Array.from(document.querySelectorAll('.tipo-clase-check:checked'))
                .map(cb => cb.value);
            const comentarios = document.getElementById('comentarios-clase').value;

            // Calcular si es urgente (examen en ‚â§7 d√≠as)
            const urgente = fechaExamen ? 
                (new Date(fechaExamen) - new Date()) <= 7 * 24 * 60 * 60 * 1000 : false;

            // CORRECCI√ìN CR√çTICA: Distribuir las horas entre los subtemas
            const horasPorSubtema = Math.ceil(horas / subtemasSeleccionados.length);

            temasSeleccionados.forEach(tema => {
                const subtemasDelTema = subtemasSeleccionados
                    .filter(s => s.tema === tema)
                    .map(s => s.subtema);

                if (subtemasDelTema.length > 0) {
                    const temaData = {
                        curso: estudianteActual.curso,
                        asignatura: asignatura,
                        tema: tema,
                        subtemas: subtemasDelTema,
                        nota: nivel,
                        horas: horasPorSubtema, // Horas distribuidas
                        fechaExamen: fechaExamen || null,
                        urgente: urgente,
                        tiposClase: tiposClase.length > 0 ? tiposClase : ['Ejercicios'],
                        comentarios: comentarios,
                        archivos: []
                    };

                    estudianteActual.temas.push(temaData);
                }
            });

            guardarEstudiantes();
            mostrarResumenSolicitud();
            mostrarScreen('screen-confirmacion');
        }

        function mostrarResumenSolicitud() {
            const resumen = document.getElementById('resumen-solicitud');
            let html = '<div class="solicitud-card">';
            html += `<h3 style="color: #48ed83; margin-bottom: 15px;">üìö Resumen de tu solicitud</h3>`;
            
            estudianteActual.temas.forEach((tema, index) => {
                html += `
                    <div style="background: var(--surface-2); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${tema.asignatura}</strong> - ${tema.tema}<br>
                        <small>Subtemas: ${tema.subtemas.join(', ')}</small><br>
                        <small>Horas solicitadas: ${tema.horas} ${tema.urgente ? '‚ö†Ô∏è URGENTE' : ''}</small>
                    </div>
                `;
            });
            
            html += '</div>';
            resumen.innerHTML = html;
        }

        function solicitarOtraTema() {
            mostrarScreen('screen-asignatura');
        }

        function finalizarSolicitud() {
            // Marcar que ya no es nuevo si hizo clase de prueba
            if (estudianteActual.esNuevo && estudianteActual.tienePrueba) {
                estudianteActual.esNuevo = false;
            }
            guardarEstudiantes();
            mostrarScreen('screen-gracias');
        }

        // ============== ALGORITMO DE PLANIFICACI√ìN V6.2 ==============
        function generarPlanificacion() {
            // Mostrar loading
            document.getElementById('btn-planificar-text').style.display = 'none';
            document.getElementById('btn-planificar-loading').style.display = 'inline-block';

            setTimeout(() => {
                try {
                    // Limpiar planificaci√≥n anterior
                    clasesPlanificadas = [];
                    estudiantesNoAsignados = [];

                    // 1. Preparar necesidades (CORREGIDO: horas exactas)
                    const necesidades = prepararNecesidadesV2();
                    
                    // 2. Inicializar tracking
                    const tracking = inicializarTracking();
                    
                    // 3. Agrupar por similitud
                    const grupos = agruparPorSimilitud(necesidades);
                    
                    // 4. Asignar clases con priorizaci√≥n
                    asignarClasesV2(grupos, tracking);
                    
                    // 5. Identificar no asignados
                    identificarNoAsignados(necesidades, tracking);
                    
                    // 6. Mostrar resultados
                    mostrarResultadosPlanificacion();
                    
                    // Ocultar loading
                    document.getElementById('btn-planificar-text').style.display = 'inline';
                    document.getElementById('btn-planificar-loading').style.display = 'none';
                    
                } catch (error) {
                    console.error('Error en planificaci√≥n:', error);
                    alert('Error al generar la planificaci√≥n: ' + error.message);
                    document.getElementById('btn-planificar-text').style.display = 'inline';
                    document.getElementById('btn-planificar-loading').style.display = 'none';
                }
            }, 100);
        }

        function prepararNecesidadesV2() {
            const necesidades = [];

            estudiantes.forEach(estudiante => {
                estudiante.temas.forEach(tema => {
                    // Clasificar nivel en 4 grupos
                    let nivelGrupo;
                    if (tema.nota < 5) nivelGrupo = 'MUY_BAJO';
                    else if (tema.nota < 7) nivelGrupo = 'BAJO';
                    else if (tema.nota < 8.5) nivelGrupo = 'ALTO';
                    else nivelGrupo = 'MUY_ALTO';

                    // CORRECCI√ìN: Crear una necesidad por subtema con horas distribuidas
                    tema.subtemas.forEach(subtema => {
                        necesidades.push({
                            estudiante: estudiante,
                            curso: tema.curso,
                            asignatura: tema.asignatura,
                            tema: tema.tema,
                            subtema: subtema,
                            nivelGrupo: nivelGrupo,
                            horas: tema.horas, // Horas ya distribuidas por subtema
                            urgente: tema.urgente,
                            tiposClase: tema.tiposClase,
                            comentarios: tema.comentarios,
                            archivos: tema.archivos || [],
                            disponibilidad: estudiante.disponibilidad,
                            esPrueba: estudiante.tienePrueba || estudiante.esNuevo
                        });
                    });
                });
            });

            return necesidades;
        }

        function agruparPorSimilitud(necesidades) {
            const grupos = {};
            
            necesidades.forEach(nec => {
                // CLAVE DE AGRUPACI√ìN: Incluye curso para separar 1¬∫ y 2¬∫ Bach
                const clave = `${nec.curso}|${nec.asignatura}|${nec.tema}|${nec.subtema}|${nec.nivelGrupo}|${nec.tiposClase.join(',')}`;
                
                if (!grupos[clave]) {
                    grupos[clave] = [];
                }
                grupos[clave].push(nec);
            });

            // Ordenar grupos: Urgentes primero, luego por tama√±o
            return Object.entries(grupos).sort((a, b) => {
                const urgentesA = a[1].filter(n => n.urgente).length;
                const urgentesB = b[1].filter(n => n.urgente).length;
                if (urgentesB !== urgentesA) return urgentesB - urgentesA;
                return b[1].length - a[1].length; // Grupos m√°s grandes primero
            });
        }

        function asignarClasesV2(gruposArray, tracking) {
            gruposArray.forEach(([clave, grupo]) => {
                const [curso, asignatura, tema, subtema, nivelGrupo, tiposClase] = clave.split('|');
                
                // Crear mapa de estudiantes pendientes
                const estudiantesPendientes = {};
                grupo.forEach(nec => {
                    if (!estudiantesPendientes[nec.estudiante.id]) {
                        estudiantesPendientes[nec.estudiante.id] = {
                            estudiante: nec.estudiante,
                            horasPendientes: nec.horas,
                            necesidad: nec
                        };
                    }
                });

                // Asignar clases mientras haya horas pendientes
                let iteraciones = 0;
                const MAX_ITERACIONES = 100;

                while (Object.values(estudiantesPendientes).some(ep => ep.horasPendientes > 0) && iteraciones < MAX_ITERACIONES) {
                    iteraciones++;

                    // Encontrar mejor slot (priorizando grupos grandes)
                    const mejorAsignacion = encontrarMejorSlotV2(
                        Object.values(estudiantesPendientes),
                        asignatura,
                        tracking
                    );

                    if (!mejorAsignacion) break;

                    // Crear la clase
                    const tienePrueba = mejorAsignacion.estudiantes.some(ep => ep.necesidad.esPrueba);
                    const esIndividual = mejorAsignacion.estudiantes.length === 1;

                    const nuevaClase = {
                        tipo: tiposClase,
                        curso: curso,
                        asignatura: asignatura,
                        tema: tema,
                        subtema: subtema,
                        nivelGrupo: nivelGrupo,
                        estudiantes: mejorAsignacion.estudiantes.map(ep => ep.estudiante),
                        nombresAlumnos: mejorAsignacion.estudiantes.map(ep => ep.estudiante.nombre),
                        tiposClase: tiposClase.split(','),
                        profesor: mejorAsignacion.profesor,
                        slot: mejorAsignacion.slot,
                        capacidad: mejorAsignacion.estudiantes.length,
                        urgente: mejorAsignacion.estudiantes.some(ep => ep.necesidad.urgente),
                        esPrueba: tienePrueba,
                        esIndividual: esIndividual,
                        comentarios: mejorAsignacion.estudiantes.map(ep => ep.necesidad.comentarios).filter(c => c),
                        archivos: mejorAsignacion.estudiantes.flatMap(ep => ep.necesidad.archivos)
                    };

                    clasesPlanificadas.push(nuevaClase);

                    // Actualizar tracking
                    const [dia] = mejorAsignacion.slot.split('-');
                    mejorAsignacion.estudiantes.forEach(ep => {
                        tracking.estudiantesHorasDia[ep.estudiante.id][dia]++;
                        tracking.estudianteSlotsOcupados[ep.estudiante.id].add(mejorAsignacion.slot);
                        ep.horasPendientes--;
                    });
                }
            });

            // Reordenar clases individuales a horarios de baja demanda
            reordenarClasesIndividuales();
        }

        function encontrarMejorSlotV2(estudiantesPendientes, asignatura, tracking) {
            const slots = generarTodosLosSlots();
            let mejorSlot = null;
            let maxEstudiantes = 0;

            // Calcular demanda por slot
            const demandaPorSlot = {};
            slots.forEach(slot => {
                demandaPorSlot[slot] = estudiantesPendientes.filter(ep => 
                    ep.estudiante.disponibilidad.includes(slot)
                ).length;
            });

            for (const slot of slots) {
                const profesor = encontrarProfesorDisponible(asignatura, slot);
                if (!profesor) continue;

                // Verificar si el slot ya est√° ocupado
                const slotOcupado = clasesPlanificadas.some(c => c.slot === slot);

                const estudiantesDisponibles = estudiantesPendientes.filter(ep => {
                    const [dia] = slot.split('-');
                    return ep.horasPendientes > 0 &&
                           ep.estudiante.disponibilidad.includes(slot) &&
                           tracking.estudiantesHorasDia[ep.estudiante.id][dia] < 2 &&
                           !tracking.estudianteSlotsOcupados[ep.estudiante.id].has(slot);
                });

                // Priorizar slots sin conflictos y con m√°s estudiantes
                const prioridad = slotOcupado ? 0.5 : 1;
                const score = estudiantesDisponibles.length * prioridad;

                if (score > maxEstudiantes) {
                    maxEstudiantes = score;
                    mejorSlot = {
                        slot: slot,
                        profesor: profesor,
                        estudiantes: estudiantesDisponibles.slice(0, 10) // Max 10 estudiantes
                    };
                }
            }

            return maxEstudiantes > 0 ? mejorSlot : null;
        }

        function reordenarClasesIndividuales() {
            // Identificar clases individuales
            const individuales = clasesPlanificadas.filter(c => c.esIndividual);
            const noIndividuales = clasesPlanificadas.filter(c => !c.esIndividual);

            // Calcular demanda por slot
            const demandaPorSlot = {};
            DIAS.forEach(dia => {
                HORAS.forEach(hora => {
                    const slot = `${dia}-${hora}`;
                    demandaPorSlot[slot] = noIndividuales.filter(c => c.slot === slot).length;
                });
            });

            // Mover individuales a slots de baja demanda
            individuales.forEach(claseInd => {
                const estudianteId = claseInd.estudiantes[0].id;
                const disponibilidad = claseInd.estudiantes[0].disponibilidad;

                // Buscar slot con menor demanda en la disponibilidad del estudiante
                let mejorSlot = claseInd.slot;
                let minDemanda = demandaPorSlot[claseInd.slot] || 0;

                disponibilidad.forEach(slot => {
                    const demanda = demandaPorSlot[slot] || 0;
                    if (demanda < minDemanda) {
                        mejorSlot = slot;
                        minDemanda = demanda;
                    }
                });

                claseInd.slot = mejorSlot;
            });
        }

        function identificarNoAsignados(necesidades, tracking) {
            estudiantesNoAsignados = [];

            const estudiantesConClase = new Set(
                clasesPlanificadas.flatMap(c => c.estudiantes.map(e => e.id))
            );

            const estudiantesConSolicitud = new Set(
                necesidades.map(n => n.estudiante.id)
            );

            estudiantesConSolicitud.forEach(estId => {
                if (!estudiantesConClase.has(estId)) {
                    const est = estudiantes.find(e => e.id === estId);
                    const solicitudes = necesidades.filter(n => n.estudiante.id === estId);
                    
                    solicitudes.forEach(sol => {
                        // Determinar raz√≥n
                        let razon = 'Sin disponibilidad compatible';
                        const hayProfesor = profesores.some(p => 
                            p.materias.includes(sol.asignatura) &&
                            p.disponibilidad.some(s => est.disponibilidad.includes(s))
                        );
                        
                        if (!hayProfesor) {
                            razon = 'Sin profesor disponible para la asignatura';
                        }

                        estudiantesNoAsignados.push({
                            estudiante: est,
                            asignatura: sol.asignatura,
                            tema: sol.tema,
                            subtema: sol.subtema,
                            horasSolicitadas: sol.horas,
                            razon: razon
                        });
                    });
                }
            });
        }

        function mostrarResultadosPlanificacion() {
            // Mostrar alerta de √©xito
            const alertaDiv = document.getElementById('alerta-planificacion');
            alertaDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Planificaci√≥n generada correctamente con ${clasesPlanificadas.length} clases
                </div>
            `;

            // Mostrar estad√≠sticas
            mostrarEstadisticasPlanificacion();

            // Mostrar no asignados
            if (estudiantesNoAsignados.length > 0) {
                mostrarNoAsignados();
            } else {
                document.getElementById('seccion-no-asignados').style.display = 'none';
            }

            // Mostrar horario
            renderizarHorario();
            document.getElementById('horario-semanal').style.display = 'block';
        }

        function mostrarEstadisticasPlanificacion() {
            const container = document.getElementById('stats-planificacion');
            container.style.display = 'grid';

            const totalClases = clasesPlanificadas.length;
            const estudiantesUnicos = new Set(clasesPlanificadas.flatMap(c => c.estudiantes.map(e => e.id))).size;
            const clasesIndividuales = clasesPlanificadas.filter(c => c.esIndividual).length;
            const clasesGrupales = totalClases - clasesIndividuales;
            const ocupacionMedia = totalClases > 0 ? 
                (clasesPlanificadas.reduce((sum, c) => sum + c.capacidad, 0) / totalClases).toFixed(1) : 0;
            const clasesUrgentes = clasesPlanificadas.filter(c => c.urgente).length;
            const clasesPrueba = clasesPlanificadas.filter(c => c.esPrueba).length;

            container.innerHTML = `
                <div class="stat-card">
                    <h3>${totalClases}</h3>
                    <p>Clases Totales</p>
                </div>
                <div class="stat-card">
                    <h3>${estudiantesUnicos}</h3>
                    <p>Alumnos con Clase</p>
                </div>
                <div class="stat-card">
                    <h3>${clasesGrupales}</h3>
                    <p>Clases Grupales</p>
                </div>
                <div class="stat-card">
                    <h3>${clasesIndividuales}</h3>
                    <p>Clases Individuales</p>
                </div>
                <div class="stat-card">
                    <h3>${ocupacionMedia}</h3>
                    <p>Ocupaci√≥n Media</p>
                </div>
                <div class="stat-card">
                    <h3>${clasesUrgentes}</h3>
                    <p>Clases Urgentes</p>
                </div>
                <div class="stat-card">
                    <h3>${clasesPrueba}</h3>
                    <p>Clases de Prueba</p>
                </div>
                <div class="stat-card">
                    <h3>${estudiantesNoAsignados.length}</h3>
                    <p>Sin Asignar</p>
                </div>
            `;
        }

        function mostrarNoAsignados() {
            const container = document.getElementById('lista-no-asignados');
            const seccion = document.getElementById('seccion-no-asignados');
            
            seccion.style.display = 'block';
            container.innerHTML = '';

            estudiantesNoAsignados.forEach(na => {
                const div = document.createElement('div');
                div.className = 'no-assigned-item';
                div.innerHTML = `
                    <strong>${na.estudiante.nombre}</strong><br>
                    <small>
                        üìö ${na.asignatura} - ${na.tema} > ${na.subtema}<br>
                        ‚è±Ô∏è ${na.horasSolicitadas} horas solicitadas<br>
                        ‚ö†Ô∏è Raz√≥n: ${na.razon}
                    </small>
                `;
                container.appendChild(div);
            });
        }

        function renderizarHorario() {
            const grid = document.getElementById('schedule-grid');
            grid.innerHTML = '';

            // Headers
            const emptyHeader = document.createElement('div');
            emptyHeader.className = 'schedule-header';
            grid.appendChild(emptyHeader);

            DIAS.forEach(dia => {
                const header = document.createElement('div');
                header.className = 'schedule-header';
                header.textContent = dia;
                grid.appendChild(header);
            });

            // Celdas
            HORAS.forEach(hora => {
                const timeCell = document.createElement('div');
                timeCell.className = 'schedule-cell time';
                timeCell.textContent = hora;
                grid.appendChild(timeCell);

                DIAS.forEach(dia => {
                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell';
                    cell.dataset.slot = `${dia}-${hora}`;
                    cell.ondrop = drop;
                    cell.ondragover = allowDrop;

                    // Buscar clases en este slot
                    const clasesEnSlot = clasesPlanificadas.filter(c => c.slot === `${dia}-${hora}`);
                    
                    clasesEnSlot.forEach(clase => {
                        const card = crearTarjetaClase(clase);
                        cell.appendChild(card);
                    });

                    grid.appendChild(cell);
                });
            });
        }

        function crearTarjetaClase(clase) {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.draggable = true;
            card.ondragstart = drag;
            card.onclick = () => mostrarDetalleClase(clase);
            card.dataset.claseId = clasesPlanificadas.indexOf(clase);

            if (clase.esIndividual) card.classList.add('individual');
            if (clase.esPrueba) card.classList.add('prueba');
            if (clase.urgente) card.classList.add('urgente');

            let badges = '';
            if (clase.esIndividual) badges += '<span class="badge badge-individual">Individual</span>';
            if (clase.esPrueba) badges += '<span class="badge badge-prueba">PRUEBA</span>';
            if (clase.urgente) badges += '<span class="badge badge-urgente">URGENTE</span>';

            card.innerHTML = `
                <div class="class-card-header">
                    <div>
                        <strong>${clase.asignatura}</strong>
                        ${badges}
                    </div>
                    <div>${clase.capacidad} üë•</div>
                </div>
                <div class="class-card-body">
                    ${clase.subtema}<br>
                    üë®‚Äçüè´ ${clase.profesor.nombre}
                </div>
            `;

            return card;
        }

        // ============== DRAG & DROP ==============
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('droppable');
        }

        function drag(ev) {
            ev.dataTransfer.setData('claseId', ev.target.dataset.claseId);
            ev.target.classList.add('dragging');
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('droppable');
            
            const claseId = ev.dataTransfer.getData('claseId');
            const clase = clasesPlanificadas[claseId];
            const nuevoSlot = ev.currentTarget.dataset.slot;

            if (nuevoSlot && clase) {
                clase.slot = nuevoSlot;
                renderizarHorario();
            }
        }

        // ============== MODAL DETALLES CLASE ==============
        function mostrarDetalleClase(clase) {
            claseActual = clase;
            const modal = document.getElementById('modal-detalle-clase');
            const contenido = document.getElementById('detalle-clase-contenido');

            let badges = '';
            if (clase.esIndividual) badges += '<span class="badge badge-individual">Individual</span>';
            if (clase.esPrueba) badges += '<span class="badge badge-prueba">PRUEBA</span>';
            if (clase.urgente) badges += '<span class="badge badge-urgente">URGENTE</span>';

            contenido.innerHTML = `
                <div class="solicitud-card">
                    <h3 style="color: #48ed83; margin-bottom: 10px;">
                        ${clase.asignatura} ${badges}
                    </h3>
                    <p><strong>Curso:</strong> ${clase.curso}</p>
                    <p><strong>Tema:</strong> ${clase.tema}</p>
                    <p><strong>Subtema:</strong> ${clase.subtema}</p>
                    <p><strong>Nivel:</strong> ${clase.nivelGrupo}</p>
                    <p><strong>Profesor:</strong> ${clase.profesor.nombre}</p>
                    <p><strong>Horario:</strong> ${clase.slot.replace('-', ' a las ')}</p>
                    <p><strong>Alumnos (${clase.capacidad}):</strong></p>
                    <ul>
                        ${clase.nombresAlumnos.map(n => `<li>${n}</li>`).join('')}
                    </ul>
                    ${clase.comentarios.length > 0 ? `
                        <p><strong>Comentarios:</strong></p>
                        <ul>
                            ${clase.comentarios.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');
        }

        function mostrarModalEditarAlumnos() {
            // Cerrar modal de detalles
            cerrarModal('modal-detalle-clase');

            // Abrir modal de edici√≥n
            const modal = document.getElementById('modal-editar-alumnos');
            const listaActuales = document.getElementById('lista-alumnos-actuales');
            const selectA√±adir = document.getElementById('select-a√±adir-alumnos');

            // Mostrar alumnos actuales
            listaActuales.innerHTML = '';
            claseActual.estudiantes.forEach(est => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px; background: var(--surface-2); border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;';
                div.innerHTML = `
                    <span>${est.nombre}</span>
                    <button class="btn btn-danger btn-sm" onclick="quitarAlumnoClase(${est.id})">Quitar</button>
                `;
                listaActuales.appendChild(div);
            });

            // Mostrar alumnos disponibles para a√±adir
            selectA√±adir.innerHTML = '';
            const alumnosDisponibles = estudiantes.filter(e => 
                !claseActual.estudiantes.some(ce => ce.id === e.id) &&
                e.disponibilidad.includes(claseActual.slot) &&
                e.curso === claseActual.curso // Mismo curso
            );

            alumnosDisponibles.forEach(est => {
                const option = document.createElement('option');
                option.value = est.id;
                option.textContent = est.nombre;
                selectA√±adir.appendChild(option);
            });

            modal.classList.add('active');
        }

        function quitarAlumnoClase(estudianteId) {
            claseActual.estudiantes = claseActual.estudiantes.filter(e => e.id !== estudianteId);
            claseActual.nombresAlumnos = claseActual.estudiantes.map(e => e.nombre);
            claseActual.capacidad = claseActual.estudiantes.length;
            claseActual.esIndividual = claseActual.capacidad === 1;
            
            mostrarModalEditarAlumnos();
        }

        function guardarEdicionAlumnos() {
            const selectA√±adir = document.getElementById('select-a√±adir-alumnos');
            const selectedIds = Array.from(selectA√±adir.selectedOptions).map(o => parseInt(o.value));

            selectedIds.forEach(id => {
                const estudiante = estudiantes.find(e => e.id === id);
                if (estudiante && !claseActual.estudiantes.some(e => e.id === id)) {
                    claseActual.estudiantes.push(estudiante);
                    claseActual.nombresAlumnos.push(estudiante.nombre);
                }
            });

            claseActual.capacidad = claseActual.estudiantes.length;
            claseActual.esIndividual = claseActual.capacidad === 1;

            cerrarModal('modal-editar-alumnos');
            renderizarHorario();
            mostrarEstadisticasPlanificacion();
            alert('Alumnos actualizados correctamente');
        }

        function eliminarClaseActual() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta clase?')) {
                const index = clasesPlanificadas.indexOf(claseActual);
                if (index > -1) {
                    clasesPlanificadas.splice(index, 1);
                }
                cerrarModal('modal-detalle-clase');
                renderizarHorario();
                mostrarEstadisticasPlanificacion();
            }
        }

        // ============== A√ëADIR CLASE MANUAL ==============
        function mostrarModalA√±adirClase() {
            const modal = document.getElementById('modal-a√±adir-clase');
            
            // Llenar select de profesores
            const selectProf = document.getElementById('manual-profesor');
            selectProf.innerHTML = '<option value="">Selecciona un profesor</option>';
            profesores.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = `${prof.nombre} (${prof.materias.join(', ')})`;
                selectProf.appendChild(option);
            });

            // Llenar select de slots
            const selectSlot = document.getElementById('manual-slot');
            selectSlot.innerHTML = '<option value="">Selecciona d√≠a y hora</option>';
            DIAS.forEach(dia => {
                HORAS.forEach(hora => {
                    const slot = `${dia}-${hora}`;
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = `${dia} a las ${hora}`;
                    selectSlot.appendChild(option);
                });
            });

            // Llenar select de alumnos
            const selectAlumnos = document.getElementById('manual-alumnos');
            selectAlumnos.innerHTML = '';
            estudiantes.forEach(est => {
                const option = document.createElement('option');
                option.value = est.id;
                option.textContent = `${est.nombre} (${est.curso})`;
                selectAlumnos.appendChild(option);
            });

            modal.classList.add('active');
        }

        function guardarClaseManual() {
            const curso = document.getElementById('manual-curso').value;
            const asignatura = document.getElementById('manual-asignatura').value;
            const tema = document.getElementById('manual-tema').value;
            const subtema = document.getElementById('manual-subtema').value;
            const profId = parseInt(document.getElementById('manual-profesor').value);
            const slot = document.getElementById('manual-slot').value;
            const alumnosIds = Array.from(document.getElementById('manual-alumnos').selectedOptions)
                .map(o => parseInt(o.value));

            if (!curso || !asignatura || !tema || !subtema || !profId || !slot) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            const profesor = profesores.find(p => p.id === profId);
            const alumnos = estudiantes.filter(e => alumnosIds.includes(e.id));

            const nuevaClase = {
                tipo: 'Manual',
                curso: curso,
                asignatura: asignatura,
                tema: tema,
                subtema: subtema,
                nivelGrupo: 'MIXTO',
                estudiantes: alumnos,
                nombresAlumnos: alumnos.map(a => a.nombre),
                tiposClase: ['Manual'],
                profesor: profesor,
                slot: slot,
                capacidad: alumnos.length,
                urgente: false,
                esPrueba: false,
                esIndividual: alumnos.length === 1,
                comentarios: ['Clase a√±adida manualmente'],
                archivos: []
            };

            clasesPlanificadas.push(nuevaClase);
            cerrarModal('modal-a√±adir-clase');
            renderizarHorario();
            mostrarEstadisticasPlanificacion();
            alert('Clase a√±adida correctamente');
        }

        // ============== CONFIRMAR HORARIO ==============
        function confirmarHorario() {
            if (confirm('¬øConfirmar este horario como definitivo? Esta acci√≥n marcar√° el horario como confirmado.')) {
                horarioConfirmado = true;
                document.getElementById('horario-confirmado-badge').style.display = 'inline-block';
                
                // Aqu√≠ ir√≠a la integraci√≥n con GoHighLevel
                alert('Horario confirmado. Preparado para integraci√≥n con GoHighLevel.');
            }
        }

        function limpiarPlanificacion() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar la planificaci√≥n actual?')) {
                clasesPlanificadas = [];
                estudiantesNoAsignados = [];
                horarioConfirmado = false;
                document.getElementById('horario-confirmado-badge').style.display = 'none';
                document.getElementById('stats-planificacion').style.display = 'none';
                document.getElementById('seccion-no-asignados').style.display = 'none';
                document.getElementById('horario-semanal').style.display = 'none';
                document.getElementById('alerta-planificacion').innerHTML = '';
            }
        }

        // ============== EXPORTACI√ìN ==============
        function exportarExcel() {
            if (clasesPlanificadas.length === 0) {
                alert('No hay planificaci√≥n para exportar');
                return;
            }

            // Crear workbook
            const wb = XLSX.utils.book_new();

            // Hoja 1: Horario Semanal
            const horarioData = [['Hora', ...DIAS]];
            HORAS.forEach(hora => {
                const fila = [hora];
                DIAS.forEach(dia => {
                    const slot = `${dia}-${hora}`;
                    const clases = clasesPlanificadas.filter(c => c.slot === slot);
                    const texto = clases.length > 0 ?
                        clases.map(c => `${c.asignatura} - ${c.subtema} (${c.capacidad} alumnos) - Prof. ${c.profesor.nombre}`).join('\n') :
                        '';
                    fila.push(texto);
                });
                horarioData.push(fila);
            });
            const ws1 = XLSX.utils.aoa_to_sheet(horarioData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Horario Semanal');

            // Hoja 2: Listado de Clases
            const clasesData = [
                ['D√≠a', 'Hora', 'Asignatura', 'Tema', 'Subtema', 'Nivel', 'Profesor', 'Alumnos', 'Tipo']
            ];
            clasesPlanificadas.forEach(c => {
                const [dia, hora] = c.slot.split('-');
                clasesData.push([
                    dia,
                    hora,
                    c.asignatura,
                    c.tema,
                    c.subtema,
                    c.nivelGrupo,
                    c.profesor.nombre,
                    c.nombresAlumnos.join(', '),
                    c.esIndividual ? 'Individual' : c.esPrueba ? 'Prueba' : 'Grupal'
                ]);
            });
            const ws2 = XLSX.utils.aoa_to_sheet(clasesData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Listado de Clases');

            // Hoja 3: Alumnos por Clase
            const alumnosData = [['Alumno', 'Email', 'Curso', 'Asignatura', 'Tema', 'Subtema', 'D√≠a', 'Hora']];
            clasesPlanificadas.forEach(c => {
                const [dia, hora] = c.slot.split('-');
                c.estudiantes.forEach(est => {
                    alumnosData.push([
                        est.nombre,
                        est.email,
                        est.curso,
                        c.asignatura,
                        c.tema,
                        c.subtema,
                        dia,
                        hora
                    ]);
                });
            });
            const ws3 = XLSX.utils.aoa_to_sheet(alumnosData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Alumnos por Clase');

            // Hoja 4: No Asignados
            if (estudiantesNoAsignados.length > 0) {
                const noAsignadosData = [['Alumno', 'Email', 'Asignatura', 'Tema', 'Subtema', 'Horas', 'Raz√≥n']];
                estudiantesNoAsignados.forEach(na => {
                    noAsignadosData.push([
                        na.estudiante.nombre,
                        na.estudiante.email,
                        na.asignatura,
                        na.tema,
                        na.subtema,
                        na.horasSolicitadas,
                        na.razon
                    ]);
                });
                const ws4 = XLSX.utils.aoa_to_sheet(noAsignadosData);
                XLSX.utils.book_append_sheet(wb, ws4, 'No Asignados');
            }

            // Descargar
            XLSX.writeFile(wb, `Planificacion_notDumb_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportarPNG() {
            if (clasesPlanificadas.length === 0) {
                alert('No hay planificaci√≥n para exportar');
                return;
            }

            const horario = document.getElementById('schedule-grid');
            
            html2canvas(horario, {
                backgroundColor: '#0F1A0F',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Horario_notDumb_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // ============== GESTI√ìN DE PROFESORES ==============
        function mostrarModalProfesor() {
            // Generar grid de disponibilidad
            const grid = document.getElementById('profesor-disponibilidad-grid');
            grid.innerHTML = '';
            
            HORAS.forEach(hora => {
                DIAS.forEach(dia => {
                    const slot = `${dia}-${hora}`;
                    const div = document.createElement('div');
                    div.className = 'horario-slot';
                    div.textContent = `${dia.substring(0, 3)}\n${hora}`;
                    div.onclick = () => {
                        div.classList.toggle('selected');
                    };
                    grid.appendChild(div);
                });
            });

            document.getElementById('modal-profesor').classList.add('active');
        }

        function guardarProfesor() {
            const nombre = document.getElementById('profesor-nombre').value.trim();
            const materias = Array.from(document.querySelectorAll('.materia-check:checked'))
                .map(cb => cb.value);
            const disponibilidad = Array.from(document.querySelectorAll('#profesor-disponibilidad-grid .horario-slot.selected'))
                .map(div => div.textContent.trim().replace('\n', '-'));

            if (!nombre || materias.length === 0) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            const nuevoProfesor = {
                id: Date.now(),
                nombre: nombre,
                materias: materias,
                disponibilidad: disponibilidad.length > 0 ? disponibilidad : generarTodosLosSlots()
            };

            profesores.push(nuevoProfesor);
            guardarProfesores();
            cerrarModal('modal-profesor');
            actualizarProfesores();
            alert('Profesor a√±adido correctamente');
        }

        function actualizarProfesores() {
            const lista = document.getElementById('lista-profesores');
            lista.innerHTML = '';

            profesores.forEach(prof => {
                const card = document.createElement('div');
                card.className = 'profesor-card';
                card.innerHTML = `
                    <h4 style="color: var(--text); margin-bottom: 10px;">${prof.nombre}</h4>
                    <p><strong>Materias:</strong> ${prof.materias.join(', ')}</p>
                    <p><strong>Disponibilidad:</strong> ${prof.disponibilidad.length} slots</p>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-danger btn-sm" onclick="eliminarProfesor(${prof.id})">Eliminar</button>
                    </div>
                `;
                lista.appendChild(card);
            });
        }

        function eliminarProfesor(id) {
            if (confirm('¬øEst√°s seguro de eliminar este profesor?')) {
                profesores = profesores.filter(p => p.id !== id);
                guardarProfesores();
                actualizarProfesores();
            }
        }

        // ============== SOLICITUDES ADMIN ==============
        function actualizarSolicitudes() {
            // Estad√≠sticas
            const stats = document.getElementById('stats-solicitudes');
            const totalEstudiantes = estudiantes.length;
            const totalSolicitudes = estudiantes.reduce((sum, e) => sum + e.temas.length, 0);
            const urgentes = estudiantes.reduce((sum, e) => 
                sum + e.temas.filter(t => t.urgente).length, 0
            );
            const totalHoras = estudiantes.reduce((sum, e) => 
                sum + e.temas.reduce((s, t) => s + t.horas, 0), 0
            );

            stats.innerHTML = `
                <div class="stat-card">
                    <h3>${totalEstudiantes}</h3>
                    <p>Estudiantes</p>
                </div>
                <div class="stat-card">
                    <h3>${totalSolicitudes}</h3>
                    <p>Solicitudes</p>
                </div>
                <div class="stat-card">
                    <h3>${urgentes}</h3>
                    <p>Urgentes</p>
                </div>
                <div class="stat-card">
                    <h3>${totalHoras}</h3>
                    <p>Horas Totales</p>
                </div>
            `;

            // Lista de solicitudes
            const lista = document.getElementById('lista-solicitudes');
            lista.innerHTML = '';

            estudiantes.forEach(est => {
                est.temas.forEach(tema => {
                    const card = document.createElement('div');
                    card.className = 'solicitud-card';
                    if (est.tienePrueba || est.esNuevo) card.classList.add('prueba');
                    if (tema.urgente) card.classList.add('urgente');

                    let badges = '';
                    if (est.tienePrueba || est.esNuevo) badges += '<span class="badge badge-prueba">PRUEBA</span>';
                    if (tema.urgente) badges += '<span class="badge badge-urgente">URGENTE</span>';

                    card.innerHTML = `
                        <h4 style="color: var(--text); margin-bottom: 10px;">
                            ${est.nombre} ${badges}
                        </h4>
                        <p><strong>Email:</strong> ${est.email}</p>
                        <p><strong>Curso:</strong> ${est.curso}</p>
                        <p><strong>Asignatura:</strong> ${tema.asignatura}</p>
                        <p><strong>Tema:</strong> ${tema.tema}</p>
                        <p><strong>Subtemas:</strong> ${tema.subtemas.join(', ')}</p>
                        <p><strong>Nivel:</strong> ${tema.nota}/10</p>
                        <p><strong>Horas:</strong> ${tema.horas}</p>
                        ${tema.fechaExamen ? `<p><strong>Examen:</strong> ${tema.fechaExamen}</p>` : ''}
                        ${tema.comentarios ? `<p><strong>Comentarios:</strong> ${tema.comentarios}</p>` : ''}
                    `;
                    lista.appendChild(card);
                });
            });
        }

        // ============== UTILIDADES ==============
        function generarTodosLosSlots() {
            const slots = [];
            DIAS.forEach(dia => {
                HORAS.forEach(hora => {
                    slots.push(`${dia}-${hora}`);
                });
            });
            return slots;
        }

        function inicializarTracking() {
            const tracking = {
                estudiantesHorasDia: {},
                estudianteSlotsOcupados: {}
            };

            estudiantes.forEach(est => {
                tracking.estudiantesHorasDia[est.id] = {
                    'Lunes': 0,
                    'Martes': 0,
                    'Mi√©rcoles': 0,
                    'Jueves': 0,
                    'Viernes': 0
                };
                tracking.estudianteSlotsOcupados[est.id] = new Set();
            });

            return tracking;
        }

        function encontrarProfesorDisponible(asignatura, slot) {
            return profesores.find(prof => 
                prof.materias.includes(asignatura) && 
                prof.disponibilidad.includes(slot)
            );
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function guardarEstudiantes() {
            localStorage.setItem('estudiantes', JSON.stringify(estudiantes));
        }

        function guardarProfesores() {
            localStorage.setItem('profesores', JSON.stringify(profesores));
        }

        // ============== INICIALIZACI√ìN ==============
        window.onload = function() {
            // Cargar profesores si no existen
            if (profesores.length === 0) {
                profesores = [
                    {
                        id: 1,
                        nombre: 'Prof. Garc√≠a',
                        materias: ['Matem√°ticas', 'F√≠sica'],
                        disponibilidad: generarTodosLosSlots()
                    },
                    {
                        id: 2,
                        nombre: 'Prof. Mart√≠nez',
                        materias: ['Qu√≠mica', 'Biolog√≠a'],
                        disponibilidad: generarTodosLosSlots()
                    }
                ];
                guardarProfesores();
            }
        };
    </script>
</body>
</html>
